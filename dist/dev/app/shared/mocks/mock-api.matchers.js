"use strict";
var api_interface_1 = require('../interfaces/api.interface');
var messageWith = function (expected, expectedValue, but, actualValues) {
    return expected + " " + expectedValue + ", " + but + (actualValues ? " " + actualValues : '') + ".";
};
var expectedCalledWith = 'Expected spy to have been called with';
var expectedNotCalledWith = 'Expected spy not to have been called with';
var butNeverCalled = 'but it was never called';
var butWas = 'but it was';
var butWasNot = 'but it was not';
var butCalledWith = "but it was called with";
var apiToString = function (api) {
    return api.constructor.name === 'Number' ? "Api." + api_interface_1.Api[api] : api;
};
var apiExpectationFormatterFor = function (displayName) {
    return function (expected) { return (displayName + " = " + apiToString(expected)); };
};
var objectExpectationFormatterFor = function (displayName) {
    return function (expected) { return (displayName + " =\n" + JSON.stringify(expected, null, 2) + "\n"); };
};
var booleanExpectationFormatterFor = function (displayName) {
    return function (expected) { return (displayName + " = " + expected); };
};
var stringExpectationFormatterFor = function (displayName) {
    return function (expected) { return (displayName + " = '" + expected + "'"); };
};
var objectArgumentMapperFor = function (optionKey) {
    return function (call) { return ("\n" + JSON.stringify(call.args[2][optionKey], null, 2)); };
};
var objectJoiner = '\n- and -';
var apiArgumentMapperFor = function (argumentPosition) {
    return function (call) { return apiToString(call.args[argumentPosition]); };
};
var booleanArgumentMapperFor = function (optionKey) {
    return function (call) { return call.args[2][optionKey]; };
};
var stringArgumentMapperFor = function (optionKeyOrArgumentPosition) {
    if (typeof optionKeyOrArgumentPosition === 'number') {
        return function (call) { return ("'" + call.args[optionKeyOrArgumentPosition] + "'"); };
    }
    else {
        return function (call) { return ("'" + call.args[2][optionKeyOrArgumentPosition] + "'"); };
    }
};
var indefiniteArticleFor = function (noun) {
    return 'aeiou'.split('').indexOf(noun.charAt(0)) > -1 ? 'an' : 'a';
};
var matcherFor = function (argumentPosition, expectationFormatter, argumentMapper) {
    return {
        compare: function (spy, expected) {
            var result = { pass: false, message: '' };
            var allCalls = spy.calls.all();
            var actualValues = allCalls.map(argumentMapper).join(', ');
            var expectedValue = expectationFormatter(expected);
            if (allCalls.length === 0) {
                result.pass = false;
                result.message = messageWith(expectedCalledWith, expectedValue, butNeverCalled);
                return result;
            }
            result.pass = allCalls.some(function (call) { return call.args[argumentPosition] === expected; });
            result.message = result.pass ?
                messageWith(expectedNotCalledWith, expectedValue, butWas) :
                messageWith(expectedCalledWith, expectedValue, butCalledWith, actualValues);
            return result;
        }
    };
};
var optionMatcherFor = function (optionKey, expectationFormatter, argumentMapper, argumentJoiner) {
    if (argumentJoiner === void 0) { argumentJoiner = ', '; }
    return {
        compare: function (spy, expected) {
            var result = { pass: false, message: '' };
            var allCalls = spy.calls.all();
            var allCallsWithOption = allCalls.filter(function (call) { return call.args.length > 2 && call.args[2].hasOwnProperty(optionKey); });
            var actualValues = allCallsWithOption.map(argumentMapper).join(argumentJoiner);
            var expectationIsSpecific = typeof expected !== 'undefined';
            var specificValue = expectationFormatter(expected);
            var unspecificValue = indefiniteArticleFor(optionKey) + " " + optionKey + " option";
            var butNeverCalledUnspecifically = butNeverCalled + " with any " + optionKey + " option";
            if (allCalls.length === 0) {
                result.pass = false;
                result.message = messageWith(expectedCalledWith, expectationIsSpecific ? specificValue : unspecificValue, butNeverCalled);
                return result;
            }
            if (!expectationIsSpecific) {
                result.pass = allCallsWithOption.length > 0;
                result.message = result.pass ?
                    messageWith(expectedNotCalledWith, unspecificValue, butCalledWith, actualValues) :
                    messageWith(expectedCalledWith, unspecificValue, butWasNot);
                return result;
            }
            if (allCallsWithOption.length === 0) {
                result.pass = false;
                result.message = messageWith(expectedCalledWith, specificValue, butNeverCalledUnspecifically);
                return result;
            }
            result.pass = allCallsWithOption.some(function (call) { return JSON.stringify(call.args[2][optionKey]) === JSON.stringify(expected); });
            result.message = result.pass ?
                messageWith(expectedNotCalledWith, specificValue, butWas) :
                messageWith(expectedCalledWith, specificValue, butCalledWith, actualValues);
            return result;
        }
    };
};
exports.mockApiMatchers = {
    toHaveBeenCalledWithApi: function () {
        return matcherFor(0, apiExpectationFormatterFor('api'), apiArgumentMapperFor(0));
    },
    toHaveBeenCalledWithEndpoint: function () {
        return matcherFor(1, stringExpectationFormatterFor('endpoint'), stringArgumentMapperFor(1));
    },
    toHaveBeenCalledWithBody: function () {
        return optionMatcherFor('body', objectExpectationFormatterFor('body'), objectArgumentMapperFor('body'), objectJoiner);
    },
    toHaveBeenCalledWithParameters: function () {
        return optionMatcherFor('parameters', objectExpectationFormatterFor('parameters'), objectArgumentMapperFor('parameters'), objectJoiner);
    },
    toHaveBeenCalledWithLoading: function () {
        return optionMatcherFor('loading', booleanExpectationFormatterFor('loading'), booleanArgumentMapperFor('loading'));
    },
    toHaveBeenCalledWithDownload: function () {
        return optionMatcherFor('download', booleanExpectationFormatterFor('download'), booleanArgumentMapperFor('download'));
    },
    toHaveBeenCalledWithOverridingToken: function () {
        return optionMatcherFor('overridingToken', stringExpectationFormatterFor('overridingToken'), stringArgumentMapperFor('overridingToken'));
    }
};

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9zaGFyZWQvbW9ja3MvbW9jay1hcGkubWF0Y2hlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLDhCQUFvQiw2QkFBNkIsQ0FBQyxDQUFBO0FBRWxELElBQU0sV0FBVyxHQUFhLFVBQUMsUUFBZ0IsRUFBRSxhQUFxQixFQUFFLEdBQVcsRUFBRSxZQUFxQjtJQUN4RyxNQUFNLENBQUksUUFBUSxTQUFJLGFBQWEsVUFBSyxHQUFHLElBQUcsWUFBWSxHQUFHLE1BQUksWUFBYyxHQUFHLEVBQUUsT0FBRyxDQUFDO0FBQzFGLENBQUMsQ0FBQztBQUVGLElBQU0sa0JBQWtCLEdBQVcsdUNBQXVDLENBQUM7QUFDM0UsSUFBTSxxQkFBcUIsR0FBVywyQ0FBMkMsQ0FBQztBQUNsRixJQUFNLGNBQWMsR0FBVyx5QkFBeUIsQ0FBQztBQUN6RCxJQUFNLE1BQU0sR0FBVyxZQUFZLENBQUM7QUFDcEMsSUFBTSxTQUFTLEdBQVcsZ0JBQWdCLENBQUM7QUFDM0MsSUFBTSxhQUFhLEdBQVcsd0JBQXdCLENBQUM7QUFFdkQsSUFBTSxXQUFXLEdBQWEsVUFBQyxHQUFRO0lBQ3JDLE1BQU0sQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLElBQUksS0FBSyxRQUFRLEdBQUcsU0FBTyxtQkFBRyxDQUFDLEdBQUcsQ0FBRyxHQUFHLEdBQUcsQ0FBQztBQUNyRSxDQUFDLENBQUM7QUFFRixJQUFNLDBCQUEwQixHQUFhLFVBQUMsV0FBbUI7SUFDL0QsTUFBTSxDQUFDLFVBQUMsUUFBYSxJQUFLLE9BQUEsQ0FBRyxXQUFXLFdBQU0sV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFFLEVBQTNDLENBQTJDLENBQUM7QUFDeEUsQ0FBQyxDQUFDO0FBRUYsSUFBTSw2QkFBNkIsR0FBYSxVQUFDLFdBQW1CO0lBQ2xFLE1BQU0sQ0FBQyxVQUFDLFFBQWdCLElBQUssT0FBQSxDQUFHLFdBQVcsWUFBTyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLFFBQUksRUFBMUQsQ0FBMEQsQ0FBQztBQUMxRixDQUFDLENBQUM7QUFFRixJQUFNLDhCQUE4QixHQUFhLFVBQUMsV0FBbUI7SUFDbkUsTUFBTSxDQUFDLFVBQUMsUUFBaUIsSUFBSyxPQUFBLENBQUcsV0FBVyxXQUFNLFFBQVEsQ0FBRSxFQUE5QixDQUE4QixDQUFDO0FBQy9ELENBQUMsQ0FBQztBQUVGLElBQU0sNkJBQTZCLEdBQWEsVUFBQyxXQUFtQjtJQUNsRSxNQUFNLENBQUMsVUFBQyxRQUFnQixJQUFLLE9BQUEsQ0FBRyxXQUFXLFlBQU8sUUFBUSxPQUFHLEVBQWhDLENBQWdDLENBQUM7QUFDaEUsQ0FBQyxDQUFDO0FBRUYsSUFBTSx1QkFBdUIsR0FBYSxVQUFDLFNBQWlCO0lBQzFELE1BQU0sQ0FBQyxVQUFDLElBQXNCLElBQUssT0FBQSxRQUFLLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUUsRUFBdkQsQ0FBdUQsQ0FBQztBQUM3RixDQUFDLENBQUM7QUFFRixJQUFNLFlBQVksR0FBVyxXQUFXLENBQUM7QUFFekMsSUFBTSxvQkFBb0IsR0FBYSxVQUFDLGdCQUF3QjtJQUM5RCxNQUFNLENBQUMsVUFBQyxJQUFzQixJQUFLLE9BQUEsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxFQUF4QyxDQUF3QyxDQUFDO0FBQzlFLENBQUMsQ0FBQztBQUVGLElBQU0sd0JBQXdCLEdBQWEsVUFBQyxTQUFpQjtJQUMzRCxNQUFNLENBQUMsVUFBQyxJQUFzQixJQUFLLE9BQUEsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsRUFBdkIsQ0FBdUIsQ0FBQztBQUM3RCxDQUFDLENBQUM7QUFFRixJQUFNLHVCQUF1QixHQUFhLFVBQUMsMkJBQTRDO0lBQ3JGLEVBQUUsQ0FBQyxDQUFDLE9BQU8sMkJBQTJCLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQztRQUNwRCxNQUFNLENBQUMsVUFBQyxJQUFzQixJQUFLLE9BQUEsT0FBSSxJQUFJLENBQUMsSUFBSSxDQUFDLDJCQUEyQixDQUFDLE9BQUcsRUFBN0MsQ0FBNkMsQ0FBQztJQUNuRixDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixNQUFNLENBQUMsVUFBQyxJQUFzQixJQUFLLE9BQUEsT0FBSSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLDJCQUEyQixDQUFDLE9BQUcsRUFBaEQsQ0FBZ0QsQ0FBQztJQUN0RixDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBRUYsSUFBTSxvQkFBb0IsR0FBYSxVQUFDLElBQVk7SUFDbEQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxJQUFJLEdBQUcsR0FBRyxDQUFDO0FBQ3JFLENBQUMsQ0FBQztBQUVGLElBQU0sVUFBVSxHQUFhLFVBQzNCLGdCQUF3QixFQUN4QixvQkFBOEIsRUFDOUIsY0FBbUI7SUFFbkIsTUFBTSxDQUFDO1FBQ0wsT0FBTyxFQUFFLFVBQUMsR0FBZ0IsRUFBRSxRQUFzQjtZQUNoRCxJQUFNLE1BQU0sR0FBZ0MsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUUsQ0FBQztZQUN6RSxJQUFNLFFBQVEsR0FBdUIsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUNyRCxJQUFNLFlBQVksR0FBVyxRQUFRLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUVyRSxJQUFNLGFBQWEsR0FBVyxvQkFBb0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUU3RCxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzFCLE1BQU0sQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDO2dCQUNwQixNQUFNLENBQUMsT0FBTyxHQUFHLFdBQVcsQ0FBQyxrQkFBa0IsRUFBRSxhQUFhLEVBQUUsY0FBYyxDQUFDLENBQUM7Z0JBRWhGLE1BQU0sQ0FBQyxNQUFNLENBQUM7WUFDaEIsQ0FBQztZQUVELE1BQU0sQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxRQUFRLEVBQXhDLENBQXdDLENBQUMsQ0FBQztZQUM5RSxNQUFNLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxJQUFJO2dCQUMxQixXQUFXLENBQUMscUJBQXFCLEVBQUUsYUFBYSxFQUFFLE1BQU0sQ0FBQztnQkFDekQsV0FBVyxDQUFDLGtCQUFrQixFQUFFLGFBQWEsRUFBRSxhQUFhLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFFOUUsTUFBTSxDQUFDLE1BQU0sQ0FBQztRQUNoQixDQUFDO0tBQ0YsQ0FBQztBQUNKLENBQUMsQ0FBQztBQUVGLElBQU0sZ0JBQWdCLEdBQWEsVUFDakMsU0FBaUIsRUFDakIsb0JBQThCLEVBQzlCLGNBQW1CLEVBQ25CLGNBQTZCO0lBQTdCLDhCQUE2QixHQUE3QixxQkFBNkI7SUFFN0IsTUFBTSxDQUFDO1FBQ0wsT0FBTyxFQUFFLFVBQUMsR0FBZ0IsRUFBRSxRQUFpQjtZQUMzQyxJQUFNLE1BQU0sR0FBZ0MsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxFQUFFLEVBQUUsQ0FBQztZQUV6RSxJQUFNLFFBQVEsR0FBdUIsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUNyRCxJQUFNLGtCQUFrQixHQUNwQixRQUFRLENBQUMsTUFBTSxDQUFDLFVBQUEsSUFBSSxJQUFJLE9BQUEsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxFQUE5RCxDQUE4RCxDQUFDLENBQUM7WUFDNUYsSUFBTSxZQUFZLEdBQVcsa0JBQWtCLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUV6RixJQUFNLHFCQUFxQixHQUFZLE9BQU8sUUFBUSxLQUFLLFdBQVcsQ0FBQztZQUN2RSxJQUFNLGFBQWEsR0FBVyxvQkFBb0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUM3RCxJQUFNLGVBQWUsR0FBYyxvQkFBb0IsQ0FBQyxTQUFTLENBQUMsU0FBSSxTQUFTLFlBQVMsQ0FBQztZQUV6RixJQUFNLDRCQUE0QixHQUFjLGNBQWMsa0JBQWEsU0FBUyxZQUFTLENBQUM7WUFFOUYsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUMxQixNQUFNLENBQUMsSUFBSSxHQUFHLEtBQUssQ0FBQztnQkFDcEIsTUFBTSxDQUFDLE9BQU8sR0FBRyxXQUFXLENBQUMsa0JBQWtCLEVBQUUscUJBQXFCLEdBQUcsYUFBYSxHQUFHLGVBQWUsRUFBRSxjQUFjLENBQUMsQ0FBQztnQkFFMUgsTUFBTSxDQUFDLE1BQU0sQ0FBQztZQUNoQixDQUFDO1lBRUQsRUFBRSxDQUFDLENBQUMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUM7Z0JBQzNCLE1BQU0sQ0FBQyxJQUFJLEdBQUcsa0JBQWtCLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztnQkFDNUMsTUFBTSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsSUFBSTtvQkFDMUIsV0FBVyxDQUFDLHFCQUFxQixFQUFFLGVBQWUsRUFBRSxhQUFhLEVBQUUsWUFBWSxDQUFDO29CQUNoRixXQUFXLENBQUMsa0JBQWtCLEVBQUUsZUFBZSxFQUFFLFNBQVMsQ0FBQyxDQUFDO2dCQUU5RCxNQUFNLENBQUMsTUFBTSxDQUFDO1lBQ2hCLENBQUM7WUFFRCxFQUFFLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDcEMsTUFBTSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUM7Z0JBQ3BCLE1BQU0sQ0FBQyxPQUFPLEdBQUcsV0FBVyxDQUFDLGtCQUFrQixFQUFFLGFBQWEsRUFBRSw0QkFBNEIsQ0FBQyxDQUFDO2dCQUU5RixNQUFNLENBQUMsTUFBTSxDQUFDO1lBQ2hCLENBQUM7WUFFRCxNQUFNLENBQUMsSUFBSSxHQUFHLGtCQUFrQixDQUFDLElBQUksQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLEVBQXBFLENBQW9FLENBQUMsQ0FBQztZQUNwSCxNQUFNLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxJQUFJO2dCQUMxQixXQUFXLENBQUMscUJBQXFCLEVBQUUsYUFBYSxFQUFFLE1BQU0sQ0FBQztnQkFDekQsV0FBVyxDQUFDLGtCQUFrQixFQUFFLGFBQWEsRUFBRSxhQUFhLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFFOUUsTUFBTSxDQUFDLE1BQU0sQ0FBQztRQUNoQixDQUFDO0tBQ0YsQ0FBQztBQUNKLENBQUMsQ0FBQztBQUVXLHVCQUFlLEdBQW1DO0lBQzdELHVCQUF1QixFQUFFO1FBQ3ZCLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFLDBCQUEwQixDQUFDLEtBQUssQ0FBQyxFQUFFLG9CQUFvQixDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDbkYsQ0FBQztJQUVELDRCQUE0QixFQUFFO1FBQzVCLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFLDZCQUE2QixDQUFDLFVBQVUsQ0FBQyxFQUFFLHVCQUF1QixDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDOUYsQ0FBQztJQUVELHdCQUF3QixFQUFFO1FBQ3hCLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsNkJBQTZCLENBQUMsTUFBTSxDQUFDLEVBQUUsdUJBQXVCLENBQUMsTUFBTSxDQUFDLEVBQUUsWUFBWSxDQUFDLENBQUM7SUFDeEgsQ0FBQztJQUVELDhCQUE4QixFQUFFO1FBQzlCLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLEVBQUUsNkJBQTZCLENBQUMsWUFBWSxDQUFDLEVBQUUsdUJBQXVCLENBQUMsWUFBWSxDQUFDLEVBQUUsWUFBWSxDQUFDLENBQUM7SUFDMUksQ0FBQztJQUVELDJCQUEyQixFQUFFO1FBQzNCLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsOEJBQThCLENBQUMsU0FBUyxDQUFDLEVBQUUsd0JBQXdCLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztJQUNySCxDQUFDO0lBRUQsNEJBQTRCLEVBQUU7UUFDNUIsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsRUFBRSw4QkFBOEIsQ0FBQyxVQUFVLENBQUMsRUFBRSx3QkFBd0IsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO0lBQ3hILENBQUM7SUFFRCxtQ0FBbUMsRUFBRTtRQUNuQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsaUJBQWlCLEVBQUUsNkJBQTZCLENBQUMsaUJBQWlCLENBQUMsRUFBRSx1QkFBdUIsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUM7SUFDM0ksQ0FBQztDQUNGLENBQUMiLCJmaWxlIjoiYXBwL3NoYXJlZC9tb2Nrcy9tb2NrLWFwaS5tYXRjaGVycy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFwaSB9IGZyb20gJy4uL2ludGVyZmFjZXMvYXBpLmludGVyZmFjZSc7XG5cbmNvbnN0IG1lc3NhZ2VXaXRoOiBGdW5jdGlvbiA9IChleHBlY3RlZDogc3RyaW5nLCBleHBlY3RlZFZhbHVlOiBzdHJpbmcsIGJ1dDogc3RyaW5nLCBhY3R1YWxWYWx1ZXM/OiBzdHJpbmcpOiBzdHJpbmcgPT4ge1xuICByZXR1cm4gYCR7ZXhwZWN0ZWR9ICR7ZXhwZWN0ZWRWYWx1ZX0sICR7YnV0fSR7YWN0dWFsVmFsdWVzID8gYCAke2FjdHVhbFZhbHVlc31gIDogJyd9LmA7XG59O1xuXG5jb25zdCBleHBlY3RlZENhbGxlZFdpdGg6IHN0cmluZyA9ICdFeHBlY3RlZCBzcHkgdG8gaGF2ZSBiZWVuIGNhbGxlZCB3aXRoJztcbmNvbnN0IGV4cGVjdGVkTm90Q2FsbGVkV2l0aDogc3RyaW5nID0gJ0V4cGVjdGVkIHNweSBub3QgdG8gaGF2ZSBiZWVuIGNhbGxlZCB3aXRoJztcbmNvbnN0IGJ1dE5ldmVyQ2FsbGVkOiBzdHJpbmcgPSAnYnV0IGl0IHdhcyBuZXZlciBjYWxsZWQnO1xuY29uc3QgYnV0V2FzOiBzdHJpbmcgPSAnYnV0IGl0IHdhcyc7XG5jb25zdCBidXRXYXNOb3Q6IHN0cmluZyA9ICdidXQgaXQgd2FzIG5vdCc7XG5jb25zdCBidXRDYWxsZWRXaXRoOiBzdHJpbmcgPSBgYnV0IGl0IHdhcyBjYWxsZWQgd2l0aGA7XG5cbmNvbnN0IGFwaVRvU3RyaW5nOiBGdW5jdGlvbiA9IChhcGk6IEFwaSk6IHN0cmluZyB8IEFwaSA9PiB7XG4gIHJldHVybiBhcGkuY29uc3RydWN0b3IubmFtZSA9PT0gJ051bWJlcicgPyBgQXBpLiR7QXBpW2FwaV19YCA6IGFwaTtcbn07XG5cbmNvbnN0IGFwaUV4cGVjdGF0aW9uRm9ybWF0dGVyRm9yOiBGdW5jdGlvbiA9IChkaXNwbGF5TmFtZTogc3RyaW5nKTogRnVuY3Rpb24gPT4ge1xuICByZXR1cm4gKGV4cGVjdGVkOiBBcGkpID0+IGAke2Rpc3BsYXlOYW1lfSA9ICR7YXBpVG9TdHJpbmcoZXhwZWN0ZWQpfWA7XG59O1xuXG5jb25zdCBvYmplY3RFeHBlY3RhdGlvbkZvcm1hdHRlckZvcjogRnVuY3Rpb24gPSAoZGlzcGxheU5hbWU6IHN0cmluZyk6IEZ1bmN0aW9uID0+IHtcbiAgcmV0dXJuIChleHBlY3RlZDogT2JqZWN0KSA9PiBgJHtkaXNwbGF5TmFtZX0gPVxcbiR7SlNPTi5zdHJpbmdpZnkoZXhwZWN0ZWQsIG51bGwsIDIpfVxcbmA7XG59O1xuXG5jb25zdCBib29sZWFuRXhwZWN0YXRpb25Gb3JtYXR0ZXJGb3I6IEZ1bmN0aW9uID0gKGRpc3BsYXlOYW1lOiBzdHJpbmcpOiBGdW5jdGlvbiA9PiB7XG4gIHJldHVybiAoZXhwZWN0ZWQ6IGJvb2xlYW4pID0+IGAke2Rpc3BsYXlOYW1lfSA9ICR7ZXhwZWN0ZWR9YDtcbn07XG5cbmNvbnN0IHN0cmluZ0V4cGVjdGF0aW9uRm9ybWF0dGVyRm9yOiBGdW5jdGlvbiA9IChkaXNwbGF5TmFtZTogc3RyaW5nKTogRnVuY3Rpb24gPT4ge1xuICByZXR1cm4gKGV4cGVjdGVkOiBzdHJpbmcpID0+IGAke2Rpc3BsYXlOYW1lfSA9ICcke2V4cGVjdGVkfSdgO1xufTtcblxuY29uc3Qgb2JqZWN0QXJndW1lbnRNYXBwZXJGb3I6IEZ1bmN0aW9uID0gKG9wdGlvbktleTogc3RyaW5nKTogRnVuY3Rpb24gPT4ge1xuICByZXR1cm4gKGNhbGw6IGphc21pbmUuQ2FsbEluZm8pID0+IGBcXG4ke0pTT04uc3RyaW5naWZ5KGNhbGwuYXJnc1syXVtvcHRpb25LZXldLCBudWxsLCAyKX1gO1xufTtcblxuY29uc3Qgb2JqZWN0Sm9pbmVyOiBzdHJpbmcgPSAnXFxuLSBhbmQgLSc7XG5cbmNvbnN0IGFwaUFyZ3VtZW50TWFwcGVyRm9yOiBGdW5jdGlvbiA9IChhcmd1bWVudFBvc2l0aW9uOiBudW1iZXIpID0+IHtcbiAgcmV0dXJuIChjYWxsOiBqYXNtaW5lLkNhbGxJbmZvKSA9PiBhcGlUb1N0cmluZyhjYWxsLmFyZ3NbYXJndW1lbnRQb3NpdGlvbl0pO1xufTtcblxuY29uc3QgYm9vbGVhbkFyZ3VtZW50TWFwcGVyRm9yOiBGdW5jdGlvbiA9IChvcHRpb25LZXk6IHN0cmluZyk6IEZ1bmN0aW9uID0+IHtcbiAgcmV0dXJuIChjYWxsOiBqYXNtaW5lLkNhbGxJbmZvKSA9PiBjYWxsLmFyZ3NbMl1bb3B0aW9uS2V5XTtcbn07XG5cbmNvbnN0IHN0cmluZ0FyZ3VtZW50TWFwcGVyRm9yOiBGdW5jdGlvbiA9IChvcHRpb25LZXlPckFyZ3VtZW50UG9zaXRpb246IHN0cmluZyB8IG51bWJlcik6IEZ1bmN0aW9uID0+IHtcbiAgaWYgKHR5cGVvZiBvcHRpb25LZXlPckFyZ3VtZW50UG9zaXRpb24gPT09ICdudW1iZXInKSB7XG4gICAgcmV0dXJuIChjYWxsOiBqYXNtaW5lLkNhbGxJbmZvKSA9PiBgJyR7Y2FsbC5hcmdzW29wdGlvbktleU9yQXJndW1lbnRQb3NpdGlvbl19J2A7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIChjYWxsOiBqYXNtaW5lLkNhbGxJbmZvKSA9PiBgJyR7Y2FsbC5hcmdzWzJdW29wdGlvbktleU9yQXJndW1lbnRQb3NpdGlvbl19J2A7XG4gIH1cbn07XG5cbmNvbnN0IGluZGVmaW5pdGVBcnRpY2xlRm9yOiBGdW5jdGlvbiA9IChub3VuOiBzdHJpbmcpOiBzdHJpbmcgPT4ge1xuICByZXR1cm4gJ2FlaW91Jy5zcGxpdCgnJykuaW5kZXhPZihub3VuLmNoYXJBdCgwKSkgPiAtMSA/ICdhbicgOiAnYSc7XG59O1xuXG5jb25zdCBtYXRjaGVyRm9yOiBGdW5jdGlvbiA9IChcbiAgYXJndW1lbnRQb3NpdGlvbjogbnVtYmVyLFxuICBleHBlY3RhdGlvbkZvcm1hdHRlcjogRnVuY3Rpb24sXG4gIGFyZ3VtZW50TWFwcGVyOiBhbnlcbik6IGphc21pbmUuQ3VzdG9tTWF0Y2hlciA9PiB7XG4gIHJldHVybiB7XG4gICAgY29tcGFyZTogKHNweTogamFzbWluZS5TcHksIGV4cGVjdGVkOiBBcGkgfCBzdHJpbmcpOiBqYXNtaW5lLkN1c3RvbU1hdGNoZXJSZXN1bHQgPT4ge1xuICAgICAgY29uc3QgcmVzdWx0OiBqYXNtaW5lLkN1c3RvbU1hdGNoZXJSZXN1bHQgPSB7IHBhc3M6IGZhbHNlLCBtZXNzYWdlOiAnJyB9O1xuICAgICAgY29uc3QgYWxsQ2FsbHM6IGphc21pbmUuQ2FsbEluZm9bXSA9IHNweS5jYWxscy5hbGwoKTtcbiAgICAgIGNvbnN0IGFjdHVhbFZhbHVlczogc3RyaW5nID0gYWxsQ2FsbHMubWFwKGFyZ3VtZW50TWFwcGVyKS5qb2luKCcsICcpO1xuXG4gICAgICBjb25zdCBleHBlY3RlZFZhbHVlOiBzdHJpbmcgPSBleHBlY3RhdGlvbkZvcm1hdHRlcihleHBlY3RlZCk7XG5cbiAgICAgIGlmIChhbGxDYWxscy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmVzdWx0LnBhc3MgPSBmYWxzZTtcbiAgICAgICAgcmVzdWx0Lm1lc3NhZ2UgPSBtZXNzYWdlV2l0aChleHBlY3RlZENhbGxlZFdpdGgsIGV4cGVjdGVkVmFsdWUsIGJ1dE5ldmVyQ2FsbGVkKTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfVxuXG4gICAgICByZXN1bHQucGFzcyA9IGFsbENhbGxzLnNvbWUoY2FsbCA9PiBjYWxsLmFyZ3NbYXJndW1lbnRQb3NpdGlvbl0gPT09IGV4cGVjdGVkKTtcbiAgICAgIHJlc3VsdC5tZXNzYWdlID0gcmVzdWx0LnBhc3MgP1xuICAgICAgICBtZXNzYWdlV2l0aChleHBlY3RlZE5vdENhbGxlZFdpdGgsIGV4cGVjdGVkVmFsdWUsIGJ1dFdhcykgOlxuICAgICAgICBtZXNzYWdlV2l0aChleHBlY3RlZENhbGxlZFdpdGgsIGV4cGVjdGVkVmFsdWUsIGJ1dENhbGxlZFdpdGgsIGFjdHVhbFZhbHVlcyk7XG5cbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuICB9O1xufTtcblxuY29uc3Qgb3B0aW9uTWF0Y2hlckZvcjogRnVuY3Rpb24gPSAoXG4gIG9wdGlvbktleTogc3RyaW5nLFxuICBleHBlY3RhdGlvbkZvcm1hdHRlcjogRnVuY3Rpb24sXG4gIGFyZ3VtZW50TWFwcGVyOiBhbnksXG4gIGFyZ3VtZW50Sm9pbmVyOiBzdHJpbmcgPSAnLCAnXG4pOiBqYXNtaW5lLkN1c3RvbU1hdGNoZXIgPT4ge1xuICByZXR1cm4ge1xuICAgIGNvbXBhcmU6IChzcHk6IGphc21pbmUuU3B5LCBleHBlY3RlZD86IE9iamVjdCk6IGphc21pbmUuQ3VzdG9tTWF0Y2hlclJlc3VsdCA9PiB7XG4gICAgICBjb25zdCByZXN1bHQ6IGphc21pbmUuQ3VzdG9tTWF0Y2hlclJlc3VsdCA9IHsgcGFzczogZmFsc2UsIG1lc3NhZ2U6ICcnIH07XG5cbiAgICAgIGNvbnN0IGFsbENhbGxzOiBqYXNtaW5lLkNhbGxJbmZvW10gPSBzcHkuY2FsbHMuYWxsKCk7XG4gICAgICBjb25zdCBhbGxDYWxsc1dpdGhPcHRpb246IGphc21pbmUuQ2FsbEluZm9bXVxuICAgICAgICA9IGFsbENhbGxzLmZpbHRlcihjYWxsID0+IGNhbGwuYXJncy5sZW5ndGggPiAyICYmIGNhbGwuYXJnc1syXS5oYXNPd25Qcm9wZXJ0eShvcHRpb25LZXkpKTtcbiAgICAgIGNvbnN0IGFjdHVhbFZhbHVlczogc3RyaW5nID0gYWxsQ2FsbHNXaXRoT3B0aW9uLm1hcChhcmd1bWVudE1hcHBlcikuam9pbihhcmd1bWVudEpvaW5lcik7XG5cbiAgICAgIGNvbnN0IGV4cGVjdGF0aW9uSXNTcGVjaWZpYzogYm9vbGVhbiA9IHR5cGVvZiBleHBlY3RlZCAhPT0gJ3VuZGVmaW5lZCc7XG4gICAgICBjb25zdCBzcGVjaWZpY1ZhbHVlOiBzdHJpbmcgPSBleHBlY3RhdGlvbkZvcm1hdHRlcihleHBlY3RlZCk7XG4gICAgICBjb25zdCB1bnNwZWNpZmljVmFsdWU6IHN0cmluZyA9IGAke2luZGVmaW5pdGVBcnRpY2xlRm9yKG9wdGlvbktleSl9ICR7b3B0aW9uS2V5fSBvcHRpb25gO1xuXG4gICAgICBjb25zdCBidXROZXZlckNhbGxlZFVuc3BlY2lmaWNhbGx5OiBzdHJpbmcgPSBgJHtidXROZXZlckNhbGxlZH0gd2l0aCBhbnkgJHtvcHRpb25LZXl9IG9wdGlvbmA7XG5cbiAgICAgIGlmIChhbGxDYWxscy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmVzdWx0LnBhc3MgPSBmYWxzZTtcbiAgICAgICAgcmVzdWx0Lm1lc3NhZ2UgPSBtZXNzYWdlV2l0aChleHBlY3RlZENhbGxlZFdpdGgsIGV4cGVjdGF0aW9uSXNTcGVjaWZpYyA/IHNwZWNpZmljVmFsdWUgOiB1bnNwZWNpZmljVmFsdWUsIGJ1dE5ldmVyQ2FsbGVkKTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfVxuXG4gICAgICBpZiAoIWV4cGVjdGF0aW9uSXNTcGVjaWZpYykge1xuICAgICAgICByZXN1bHQucGFzcyA9IGFsbENhbGxzV2l0aE9wdGlvbi5sZW5ndGggPiAwO1xuICAgICAgICByZXN1bHQubWVzc2FnZSA9IHJlc3VsdC5wYXNzID9cbiAgICAgICAgICBtZXNzYWdlV2l0aChleHBlY3RlZE5vdENhbGxlZFdpdGgsIHVuc3BlY2lmaWNWYWx1ZSwgYnV0Q2FsbGVkV2l0aCwgYWN0dWFsVmFsdWVzKSA6XG4gICAgICAgICAgbWVzc2FnZVdpdGgoZXhwZWN0ZWRDYWxsZWRXaXRoLCB1bnNwZWNpZmljVmFsdWUsIGJ1dFdhc05vdCk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH1cblxuICAgICAgaWYgKGFsbENhbGxzV2l0aE9wdGlvbi5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmVzdWx0LnBhc3MgPSBmYWxzZTtcbiAgICAgICAgcmVzdWx0Lm1lc3NhZ2UgPSBtZXNzYWdlV2l0aChleHBlY3RlZENhbGxlZFdpdGgsIHNwZWNpZmljVmFsdWUsIGJ1dE5ldmVyQ2FsbGVkVW5zcGVjaWZpY2FsbHkpO1xuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9XG5cbiAgICAgIHJlc3VsdC5wYXNzID0gYWxsQ2FsbHNXaXRoT3B0aW9uLnNvbWUoY2FsbCA9PiBKU09OLnN0cmluZ2lmeShjYWxsLmFyZ3NbMl1bb3B0aW9uS2V5XSkgPT09IEpTT04uc3RyaW5naWZ5KGV4cGVjdGVkKSk7XG4gICAgICByZXN1bHQubWVzc2FnZSA9IHJlc3VsdC5wYXNzID9cbiAgICAgICAgbWVzc2FnZVdpdGgoZXhwZWN0ZWROb3RDYWxsZWRXaXRoLCBzcGVjaWZpY1ZhbHVlLCBidXRXYXMpIDpcbiAgICAgICAgbWVzc2FnZVdpdGgoZXhwZWN0ZWRDYWxsZWRXaXRoLCBzcGVjaWZpY1ZhbHVlLCBidXRDYWxsZWRXaXRoLCBhY3R1YWxWYWx1ZXMpO1xuXG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbiAgfTtcbn07XG5cbmV4cG9ydCBjb25zdCBtb2NrQXBpTWF0Y2hlcnM6IGphc21pbmUuQ3VzdG9tTWF0Y2hlckZhY3RvcmllcyA9IHtcbiAgdG9IYXZlQmVlbkNhbGxlZFdpdGhBcGk6ICgpOiBqYXNtaW5lLkN1c3RvbU1hdGNoZXIgPT4ge1xuICAgIHJldHVybiBtYXRjaGVyRm9yKDAsIGFwaUV4cGVjdGF0aW9uRm9ybWF0dGVyRm9yKCdhcGknKSwgYXBpQXJndW1lbnRNYXBwZXJGb3IoMCkpO1xuICB9LFxuXG4gIHRvSGF2ZUJlZW5DYWxsZWRXaXRoRW5kcG9pbnQ6ICgpOiBqYXNtaW5lLkN1c3RvbU1hdGNoZXIgPT4ge1xuICAgIHJldHVybiBtYXRjaGVyRm9yKDEsIHN0cmluZ0V4cGVjdGF0aW9uRm9ybWF0dGVyRm9yKCdlbmRwb2ludCcpLCBzdHJpbmdBcmd1bWVudE1hcHBlckZvcigxKSk7XG4gIH0sXG5cbiAgdG9IYXZlQmVlbkNhbGxlZFdpdGhCb2R5OiAoKTogamFzbWluZS5DdXN0b21NYXRjaGVyID0+IHtcbiAgICByZXR1cm4gb3B0aW9uTWF0Y2hlckZvcignYm9keScsIG9iamVjdEV4cGVjdGF0aW9uRm9ybWF0dGVyRm9yKCdib2R5JyksIG9iamVjdEFyZ3VtZW50TWFwcGVyRm9yKCdib2R5JyksIG9iamVjdEpvaW5lcik7XG4gIH0sXG5cbiAgdG9IYXZlQmVlbkNhbGxlZFdpdGhQYXJhbWV0ZXJzOiAoKTogamFzbWluZS5DdXN0b21NYXRjaGVyID0+IHtcbiAgICByZXR1cm4gb3B0aW9uTWF0Y2hlckZvcigncGFyYW1ldGVycycsIG9iamVjdEV4cGVjdGF0aW9uRm9ybWF0dGVyRm9yKCdwYXJhbWV0ZXJzJyksIG9iamVjdEFyZ3VtZW50TWFwcGVyRm9yKCdwYXJhbWV0ZXJzJyksIG9iamVjdEpvaW5lcik7XG4gIH0sXG5cbiAgdG9IYXZlQmVlbkNhbGxlZFdpdGhMb2FkaW5nOiAoKTogamFzbWluZS5DdXN0b21NYXRjaGVyID0+IHtcbiAgICByZXR1cm4gb3B0aW9uTWF0Y2hlckZvcignbG9hZGluZycsIGJvb2xlYW5FeHBlY3RhdGlvbkZvcm1hdHRlckZvcignbG9hZGluZycpLCBib29sZWFuQXJndW1lbnRNYXBwZXJGb3IoJ2xvYWRpbmcnKSk7XG4gIH0sXG5cbiAgdG9IYXZlQmVlbkNhbGxlZFdpdGhEb3dubG9hZDogKCk6IGphc21pbmUuQ3VzdG9tTWF0Y2hlciA9PiB7XG4gICAgcmV0dXJuIG9wdGlvbk1hdGNoZXJGb3IoJ2Rvd25sb2FkJywgYm9vbGVhbkV4cGVjdGF0aW9uRm9ybWF0dGVyRm9yKCdkb3dubG9hZCcpLCBib29sZWFuQXJndW1lbnRNYXBwZXJGb3IoJ2Rvd25sb2FkJykpO1xuICB9LFxuXG4gIHRvSGF2ZUJlZW5DYWxsZWRXaXRoT3ZlcnJpZGluZ1Rva2VuOiAoKTogamFzbWluZS5DdXN0b21NYXRjaGVyID0+IHtcbiAgICByZXR1cm4gb3B0aW9uTWF0Y2hlckZvcignb3ZlcnJpZGluZ1Rva2VuJywgc3RyaW5nRXhwZWN0YXRpb25Gb3JtYXR0ZXJGb3IoJ292ZXJyaWRpbmdUb2tlbicpLCBzdHJpbmdBcmd1bWVudE1hcHBlckZvcignb3ZlcnJpZGluZ1Rva2VuJykpO1xuICB9XG59O1xuIl19
